---
title: "Get RNA sequences for select gene lists"
author: "Theo Killian"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
---

```{r, echo = FALSE, results = 'asis'}
suppressPackageStartupMessages(library("dplyr"))
knitr::opts_chunk$set(collapse=TRUE, comment="#>", warning=FALSE, message=FALSE)
```

# Introduction

This workbook uses [biomaRt](https://bioconductor.org/packages/release/bioc/html/biomaRt.html)
to obtain the 5'-3' unspliced RNA sequences (i.e. pre-mRNA) for each gene in a
user-defined specified gene list.

```{r}
# Load required libraries
library("biomaRt")
library("dplyr")
library("stringr")
```

Uncomment the code chunk if you want the full list of genes (this is not advised,
because [biomaRt](https://bioconductor.org/packages/release/bioc/html/biomaRt.html)
will likely time out due to so many queries).

```{r}
# getBM(attributes = c("entrezgene_id", "external_gene_name"),
#       mart = useDataset("mmusculus_gene_ensembl", useMart("ensembl"))) %>%
#   dplyr::rename(entrez_id = entrezgene_id,
#                 gene_symbol = external_gene_name) %>%
#   dplyr::filter(stringr::str_length(entrez_id) > 1,
#                 stringr::str_length(gene_symbol) > 1) %>%
#   as.data.frame() -> mouse_biomart
# saveRDS(object = mouse_biomart, file = "./data/mouse_biomart.rds")
```

## Load gene list

```{r}
## file path
# fp <- "~/Documents/tmp/dacruz/Axonseq_DE_meta_analysis/data/"
# target_list <- "selected_FUS_target_genes.txt"
target_list <- "selected_TARDBP_target_genes.txt"
# out <- "FUS_mouse_target_genes_sequences_"
out <- "TARDBP_mouse_target_genes_sequences_"

## read table of targets
read.table(file = paste0(fp, target_list), sep = "\t",
           header = FALSE) %>% 
  as.data.frame() -> mouse_gene_symbols
```

Function to retrieve DNA sequences from [biomaRt](https://bioconductor.org/packages/release/bioc/html/biomaRt.html)
and then convert them into RNA sequences.

```{r}
# Function to fetch DNA sequence for a given gene symbol
fetch_dna_sequence <- function(gene_symbol) {
  # Select the Ensembl mart and dataset
  ensembl <- useMart("ensembl", dataset = "mmusculus_gene_ensembl")
  
  # Query to get the gene sequence
  gene_seq <- getSequence(id = gene_symbol,
                          type = "external_gene_name",
                          seqType = "gene_exon_intron",
                          mart = ensembl)
  
  # Return the DNA sequence
  if (nrow(gene_seq) > 0) {
    return(gene_seq$gene_exon_intron[1])
  } else {
    return(NA)
  }
}

# Create a data frame to store gene symbols and their DNA sequences
gene_data <- data.frame(GeneSymbol = mouse_gene_symbols$V1,
                        DNASequence = NA,
                        stringsAsFactors = FALSE)

# Fetch DNA sequences for each gene symbol
for (i in 1:nrow(gene_data)) {
  gene_data$DNASequence[i] <- fetch_dna_sequence(gene_data$GeneSymbol[i])
}

# Function to convert DNA sequence to complementary RNA sequence
convert_dna_to_complementary_rna <- function(dna_sequence) {
  # Replace each nucleotide with its complement
  rna_sequence <- chartr("ATCG", "UAGC", dna_sequence)
  return(rna_sequence)
}

# Convert each DNA sequence to complementary RNA
gene_data$rna_sequences <- sapply(gene_data$DNASequence, convert_dna_to_complementary_rna)
names(gene_data) <- c("gene_symbol", "gene_dna_sequence", "gene_rna_sequence")
```

## Save the data frame to a TSV file

```{r}
gene_data %>%
  dplyr::filter(stringr::str_length(gene_dna_sequence) > 1) %>%
  dplyr::select(-gene_dna_sequence) %>%
  write.table(file = paste0("./", out, Sys.Date(), ".tsv"), sep = "\t",
              row.names = FALSE, col.names = TRUE, quote = FALSE)
```

```{r sessionInfo}
sessionInfo()
```
